name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-android:
    name: Build Android APK
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: 'oracle'
          java-version: '17'
          
      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          
      - name: Get Dependencies
        run: |
          cd wayland_connect_android
          flutter pub get
          
      - name: Build APK
        run: |
          cd wayland_connect_android
          flutter build apk --release
          
      - name: Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: wayland-connect-apk
          path: wayland_connect_android/build/app/outputs/flutter-apk/app-release.apk

  build-linux:
    name: Build Linux Desktop
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y clang cmake ninja-build pkg-config libgtk-3-dev liblzma-dev libstdc++-12-dev libwayland-dev libxkbcommon-dev

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'

      - name: Build Rust Backend
        run: |
          cd rust_backend
          cargo build --release
          
      - name: Build Wayland Overlay
        run: |
          cd wayland_pointer_overlay
          cargo build --release
          
      - name: Build Flutter Desktop
        run: |
          cd wayland_connect_desktop
          flutter build linux --release

      - name: Package Linux (Bundle)
        run: |
          mkdir -p release_bundle/bin
          cp rust_backend/target/release/wayland_connect_backend release_bundle/bin/
          cp wayland_pointer_overlay/target/release/wayland_pointer_overlay release_bundle/bin/
          cp -r wayland_connect_desktop/build/linux/x64/release/bundle/* release_bundle/bin/
          cd release_bundle && tar -czvf ../wayland-connect-linux-x64.tar.gz .

      - name: Upload Linux Artifact
        uses: actions/upload-artifact@v4
        with:
          name: wayland-connect-linux
          path: wayland-connect-linux-x64.tar.gz

  create-release:
    name: Create GitHub Release
    needs: [build-android, build-linux]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - name: Download Artifacts
        uses: actions/download-artifact@v4
        
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            wayland-connect-apk/app-release.apk
            wayland-connect-linux/wayland-connect-linux-x64.tar.gz
          name: Release ${{ github.ref_name }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
