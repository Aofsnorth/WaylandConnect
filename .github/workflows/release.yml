name: Build and Release

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-android:
    name: Build Android APK
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: 'oracle'
          java-version: '17'
          
      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          
      - name: Get Dependencies
        run: |
          cd wayland_connect_android
          flutter pub get
          
      - name: Build APK
        run: |
          cd wayland_connect_android
          flutter build apk --release
          
      - name: Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: wayland-connect-apk
          path: wayland_connect_android/build/app/outputs/flutter-apk/app-release.apk

  build-linux:
    name: Build Linux Desktop
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y clang cmake ninja-build pkg-config libgtk-3-dev libgtk-4-dev liblzma-dev libstdc++-12-dev libwayland-dev libxkbcommon-dev libgtk4-layer-shell-dev libfuse2

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'

      - name: Build Rust Backend
        run: |
          cd rust_backend
          cargo build --release
          
      - name: Build Wayland Overlay
        run: |
          cd wayland_pointer_overlay
          cargo build --release
          
      - name: Build Flutter Desktop
        run: |
          cd wayland_connect_desktop
          flutter build linux --release

      - name: Create AppDir for AppImage
        run: |
          mkdir -p AppDir/usr/bin
          mkdir -p AppDir/usr/lib
          mkdir -p AppDir/usr/share/applications
          mkdir -p AppDir/usr/share/icons/hicolor/512x512/apps
          
          # Copy Flutter Bundle (Binary, Libs, Data)
          # Flutter expects lib/ and data/ next to the binary
          cp wayland_connect_desktop/build/linux/x64/release/bundle/wayland_connect_desktop AppDir/usr/bin/
          cp -r wayland_connect_desktop/build/linux/x64/release/bundle/lib AppDir/usr/bin/
          cp -r wayland_connect_desktop/build/linux/x64/release/bundle/data AppDir/usr/bin/
          
          # Copy Backend & Overlay
          cp rust_backend/target/release/wayland_connect_backend AppDir/usr/bin/
          cp wayland_pointer_overlay/target/release/wayland_pointer_overlay AppDir/usr/bin/
          
          # Copy Desktop Entry & Icon
          cp wayland_connect_desktop/assets/images/app_icon.png AppDir/usr/share/icons/hicolor/512x512/apps/wayland-connect.png
          cp AppDir/usr/share/icons/hicolor/512x512/apps/wayland-connect.png AppDir/wayland-connect.png
          
          cat > AppDir/usr/share/applications/wayland-connect.desktop << EOF
          [Desktop Entry]
          Name=Wayland Connect
          Exec=wayland_connect_desktop
          Icon=wayland-connect
          Type=Application
          Categories=Utility;
          EOF
          cp AppDir/usr/share/applications/wayland-connect.desktop AppDir/
          
          # Create AppRun script
          cat > AppDir/AppRun << 'EOF'
          #!/bin/bash
          HERE="$(dirname "$(readlink -f "${0}")")"
          export PATH="${HERE}/usr/bin:${PATH}"
          export LD_LIBRARY_PATH="${HERE}/usr/bin/lib:${LD_LIBRARY_PATH}"
          exec "${HERE}/usr/bin/wayland_connect_desktop" "$@"
          EOF
          chmod +x AppDir/AppRun

      - name: Generate AppImage
        run: |
          wget -O appimagetool https://github.com/AppImage/AppImageKit/releases/download/13/appimagetool-x86_64.AppImage
          chmod +x appimagetool
          ./appimagetool --appimage-extract-and-run AppDir Wayland_Connect-x86_64.AppImage

      - name: Package Linux (Tarball backup)
        run: |
          mkdir -p release_bundle/bin
          cp -r AppDir/usr/bin/* release_bundle/bin/
          cd release_bundle && tar -czvf ../wayland-connect-linux-x64.tar.gz .

      - name: Upload Linux Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: wayland-connect-linux
          path: |
            Wayland_Connect-x86_64.AppImage
            wayland-connect-linux-x64.tar.gz

  create-release:
    name: Create GitHub Release
    needs: [build-android, build-linux]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - name: Download Artifacts
        uses: actions/download-artifact@v4
        
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            wayland-connect-apk/app-release.apk
            wayland-connect-linux/Wayland_Connect-x86_64.AppImage
            wayland-connect-linux/wayland-connect-linux-x64.tar.gz
          name: Release ${{ github.ref_name }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
